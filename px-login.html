<link rel="import" href="../polymer/polymer.html"/>
<!--
Element providing a login/logout button that integrates nicely with Cloud Foundry's UAA.

##### Usage

    <px-login></px-login>

@element px-login
@blurb Element providing a login/logout button.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-login">
    <link rel="import" type="css" href="css/px-login.css"/>
    <template>

        <div id="login-wrapper">
          <span id="profile-wrapper">
          <div id="auth" class="auth style-scope px-app-nav" hidden$="{{!userInfo.user_name}}">
            <ul id="userMenu" class="list-bare style-scope px-app-nav popover-arrow popover-arrow-right">
              <li class="style-scope px-app-nav">
                <a href="#change-profile" class="style-scope px-app-nav"><span>Change Profile</span></a>
              </li>
              <li class="style-scope px-app-nav">
                <a href="#edit-profile" class="style-scope px-app-nav"><span>Edit Profile</span></a>
              </li>
              <li class="style-scope px-app-nav">
                <a href="/logout" class="style-scope px-app-nav"><span>Sign out</span></a>
              </li>
            </ul>
          </div>
          <i id="signin-user" class="fa fa-user"></i>
          <button class="sign-in" on-click="loginHandler" hidden$="{{userInfo.user_name}}">Sign In</button>
          <span class="user-info" hidden$="{{!userInfo.user_name}}">{{userInfo.user_name}}</span>
          <i id="signin-chevron"  hidden$="{{!userInfo.user_name}}" class="fa fa-chevron-up"></i>
        </span>
          <span id="settings-wrapper">
            <!--div id="auth2" class="auth style-scope px-app-nav">
              <ul id="userMenu" class="list-bare style-scope px-app-nav popover-arrow popover-arrow-right">
                <li class="style-scope px-app-nav">
                  <a href="#change-profile" class="style-scope px-app-nav"><span>other</span></a>
                </li>
                <li class="style-scope px-app-nav">
                  <a href="#edit-profile" class="style-scope px-app-nav"><span>thing</span></a>
                </li>
                <li class="style-scope px-app-nav">
                  <a href="#signout" class="style-scope px-app-nav"><span>go</span></a>
                </li>
              </ul>
            </div-->
            <i id="signin-settings" hidden$="true" class="fa fa-cog"></i>
          </span>
        </div>

    </template>
</dom-module>

<script>
    (function () {
        window.px = window.px || {};
        px.auth = px.auth || {
            _loginUrl: null,
            set loginUrl(val) {
                this._loginUrl = val;
            },
            _logoutUrl: null,
            set logoutUrl(val) {
                this._logoutUrl = val;
            },
            _userInfoUrl: null,
            set userInfoUrl(val) {
                this._userInfoUrl = val;
            },
            login: function (clientPath) {
                if (!this._loginUrl) {
                    throw 'login url is not set';
                }
                if (!clientPath) {
                    window.location.replace(this._loginUrl + '?state=' + location.href);
                }
                window.location.replace(this._loginUrl + '?state='+ clientPath.url);
            },
            logout: function () {
                if (!this._logoutUrl) {
                    throw 'login url is not set';
                }
                window.location.replace(this._logoutUrl);
            },
            getUserInfo: function () {
                var self = this;
                if (!this._userInfoUrl) {
                    throw 'userInfo url is not set';
                }

                return new Promise(function (resolve, reject) {
                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.onreadystatechange = function () {
                        if (xmlhttp.readyState == 4) {
                            if (xmlhttp.status == 200) {
                                try {
                                    resolve(JSON.parse(xmlhttp.responseText));
                                }
                                catch (e) {
                                    reject(e);
                                }
                            }
                            else {
                                reject();
                            }
                        }
                    }
                    xmlhttp.open("GET", self._userInfoUrl, true);
                    xmlhttp.send();
                });
            },
            isAuthenticated: function () {
                return this.getUserInfo();
            }
        };

        Polymer({
            is: 'px-login',
            properties: {
                loginUrl: {
                    type: String,
                    value: '/login'
                },
                userInfoUrl: {
                    type: String,
                    value: '/userinfo'
                },
                logoutUrl: {
                    type: String,
                    value: '/logout'
                },
                defaultClientRoute: {
                    type: String,
                    value: '/about'
                }
            },
            ready: function () {
                this.userInfo = {};
                var self = this;
                window.px.auth.loginUrl = this.loginUrl;
                window.px.auth.logoutUrl = this.logoutUrl;
                window.px.auth.userInfoUrl = this.userInfoUrl;
                window.px.auth.getUserInfo().then(function (data) {
                    self.userInfo = data;
                    console.log("hide?", self.userInfo);
                    if(self.userInfo.user_name){
                      console.log("hide?", self.userInfo);
                      document.getElementById('signin-chevron').classList.remove("hidden-test");
                    }
                });
                document.getElementById('signin-settings').classList.remove("style-scope");
                document.getElementById('signin-user').classList.remove("style-scope");
                document.getElementById('signin-chevron').classList.remove("style-scope");
                console.log("hide?", self.userInfo);
                if(!self.userInfo.user_name){
                  console.log("hide?", self.userInfo);
                  document.getElementById('signin-chevron').classList.add("hidden-test");
                }
                var elm = document.getElementById('auth');
                var li = elm.getElementsByTagName("ul")[0].getElementsByTagName("li")[2]
                    li.addEventListener( "click", function(event){
                      if(event.preventDefault) event.preventDefault(); else event.returnValue = false;
                      window.location.href = "/logout"
                    })
                    console.log("ready")
            },
            loginHandler: function (event, detail, sender) {
                window.px.auth.login();
            },

            logoutHandler: function (event, detail, sender) {
                window.px.auth.logout();
            }
        });
    })();
</script>
