<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-ajax/iron-ajax.html"/>

<!--
Element providing a login/logout button that integrates nicely with Cloud Foundry's UAA.

##### Usage

    <px-login></px-login>

@element px-login
@blurb Element providing a login/logout button.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-login">
  <link rel="import" type="css" href="css/px-login.css"/>
  <template>
    <div id="logincontainer" class="login">
      <template is="dom-if" if="{{!userInfo.user_name}}">
        <button class="btn btn--bare" on-click="loginHandler">
          <i class="fa fa-user text--center u-mr--"></i>
          <span>Sign In</span>
        </button>
      </template>
      <template is="dom-if" if="{{userInfo.user_name}}">
        <button class="btn btn--bare">
          <i class="fa fa-user text--center"></i>
          <span class="u-mh--">{{userInfo.user_name}}</span>
          <i class="fa fa-angle-up"></i>
        </button>
        <ul class="dropdown-menu list-bare">
          <li on-click="logoutHandler">Sign Out</li>
          <template is="dom-repeat" items="{{menuItems}}">
            <li on-click="menuItemHandler" url="{{item.url}}">{{item.label}}</li>
          </template>
        </ul>
      </template>
    </div>
    <iron-ajax
      id="userInfoAjax"
      auto
      url="{{userInfoUrl}}"
      handle-as="json"
      on-response="handleAjaxResponse"
      on-error="handleAjaxError"
      last-response="{{userInfo}}"
      ></iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-login',

    properties: {
        loginUrl: {
            type: String,
            value: '/login'
        },
        userInfoUrl: {
            type: String,
            value: '/userinfo.json'
        },
        logoutUrl: {
            type: String,
            value: '/logout'
        },
        defaultClientRoute: {
            type: String,
            value: '/about'
        },
        userInfo: {
          type: Object,
          value: function() {
            return {};
          }
        },
        isAuthenticated: {
          type: Boolean,
          value: false,
          notify: true
        },
        /*
        Set
        * @type (ArrayBuffer|ArrayBufferView|Blob|Document|FormData|null|string|undefined|Object)
        */
        pollInterval: {
          type: Number,
          value: 10000
        },
        menuItems: {
          type: Array,
          value: function() {
            return [];
          }
        }
    },

    ready: function () {
        document.body.addEventListener('nav-height-changed', this._onNavHeightChanged.bind(this));
        document.body.addEventListener('nav-collapsing', this._onNavCollapsing.bind(this));
        document.body.addEventListener('nav-expanded', this._onNavExpanded.bind(this));
        var self = this;
        window.onscroll = function() {
          if (window.pageYOffset + window.innerHeight >= document.body.scrollHeight - 60) {
            self.toggleClass('sticky', true);
          } else {
            self.toggleClass('sticky', false);
          }
        };
        console.log(this.menuItems);
    },

    _onNavExpanded: function(){
      this.toggleClass('login--collapsed', false, this.$.logincontainer);
    },

    _onNavCollapsing: function(){
      this.toggleClass('login--collapsed', true, this.$.logincontainer);
    },

    _onNavHeightChanged: function() {
      if (window.innerHeight > document.body.clientHeight - 60) {
        this.toggleClass('sticky', true);
      } else {
        this.toggleClass('sticky', false);
      }
    },

    loginHandler: function (event, detail, sender) {
      this.login();
    },

    logoutHandler: function (event, detail, sender) {
      event.stopPropagation();
      this.logout();
    },

    handleAjaxResponse: function(request) {
      console.log(request.detail.response);
      this.set('userInfo', request.detail.response);
      this.set('isAuthenticated', true);
      var self = this;
      setTimeout(function() {
        self.$.userInfoAjax.generateRequest();
      }, this.pollInterval);
    },

    handleAjaxError: function(error,a,b,c) {
      this.login();
    },

    login: function (clientPath) {
        if (!this.loginUrl) {
            throw 'login url is not set';
        }
        if (!clientPath) {
          window.location.replace(this.loginUrl + '?state=' + location.href);
        } else {
          //this causes an error, what should it do?
          window.location.replace(this.loginUrl + '?state='+ clientPath.url);
        }
    },

    logout: function () {
        if (!this.logoutUrl) {
            throw 'login url is not set';
        }
        window.location.replace(this.logoutUrl);
    }

  });
</script>
