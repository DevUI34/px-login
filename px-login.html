<link rel="import" href="../polymer/polymer.html"/>

<!--
Element providing a login/logout button that integrates nicely with Cloud Foundry's UAA.

##### Usage

    <px-login
        menu-items='[{"label": "Setting Item 1", "url":"/user-settings1"}]'
        logout-url="logged_out.html"
        user-info-url="userInfo.js">
    </px-login>

@element px-login
@blurb Element providing a login/logout button.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-login">
  <script>
    // Conditional loading of es6-promise polyfill
    if(typeof ES6Promise === "undefined"){
      var script = document.createElement('script');
      script.async = true;
      script.src = '../es6-promise/promise.min.js';
      document.head.appendChild(script);
    }
  </script>
  <link rel="import" type="css" href="css/px-login.css"/>
  <template>
    <div id="logincontainer" class="login">
      <template is="dom-if" if="{{!userInfo.user_name}}">
        <button class="btn btn--bare" on-click="loginHandler">
          <i class="fa fa-user text--center u-mr--"></i>
          <span>Sign In</span>
        </button>
      </template>
      <template is="dom-if" if="{{userInfo.user_name}}">
        <button class="btn btn--bare">
          <i class="fa fa-user text--center"></i>
          <span class="u-mh--">{{userInfo.user_name}}</span>
          <i class="fa fa-angle-up"></i>
        </button>
        <ul class="dropdown-menu list-bare">
          <template is="dom-repeat" items="{{menuItems}}">
            <li on-click="menuItemHandler" url$="{{item.url}}"><a>{{item.label}}</a></li>
          </template>
          <li on-click="logoutHandler"><a>Sign Out</a></li>
        </ul>
      </template>
    </div>
  </template>
</dom-module>

<script>
// Separate script for the px.auth object which may later be made into its
// own px component
'use strict';
(function() {
  // use these closure vars to achieve 'private' behavior of like-named attributes
  var _loginUrl, _logoutUrl, _userInfoUrl;
  window.px = window.px || {};
  px.auth = px.auth || {
    set loginUrl(val) {
          _loginUrl = val;
        }

    , set logoutUrl(val) {
          _logoutUrl = val;
        }

    , get userInfoUrl() {
        return _userInfoUrl;
    }

    , set userInfoUrl(val) {
          _userInfoUrl = val;
        }

    , login:
      function (clientPath) {
        if (typeof _loginUrl === 'undefined') {
          throw 'login url is not set';
        }
        if (typeof clientPath === 'undefined') {
          window.location.replace(_loginUrl + '?state=' + window.location.href);
        } else {
          //this causes an error, what should it do?
          window.location.replace(_loginUrl + '?state='+ clientPath.url);
        }
      }

    , logout:
      function () {
        if (typeof _logoutUrl === 'undefined') {
          throw 'login url is not set';
        }
        window.location.replace(_logoutUrl);
      }

    , getUserInfo:
      function () {
        var self = this;
        if (!this.userInfoUrl) {
          throw 'userInfo url is not set';
        }

        return new Promise(function (resolve, reject) {
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4) {
              if (xmlhttp.status === 200) {
                try {
                  resolve(JSON.parse(xmlhttp.responseText));
                }
                catch (e) {
                  reject(e);
                }
              }
              else {
                reject();
              }
            }
          };
          xmlhttp.open("GET", self.userInfoUrl, true);
          xmlhttp.send();
        });
      }

      , isAuthenticated:
        function () {
          return this.getUserInfo();
      }

    };
  }
)();

Polymer({

  is: 'px-login'

  , properties: {
      loginUrl: {
          type: String,
          value: '/login'
      },
      userInfoUrl: {
          type: String,
          value: '/userinfo.json'
      },
      logoutUrl: {
          type: String,
          value: '/logout'
      },
      defaultClientRoute: {
          type: String,
          value: '/about'
      },
      userInfo: {
        type: Object,
        value: function() {
          return {};
        }
      },
      isAuthenticated: {
        type: Boolean,
        value: false,
        notify: true
      },

      pollInterval: {
        type: Number,
        value: 10000
      },
      menuItems: {
        type: Array,
        value: function() {
          return [];
        }
      }
  }

  , ready: function () {
      var self = this;
      var target = Polymer.dom(this.root).querySelector('#logincontainer').parentNode;
      var config = { attributes: true, childList: false, characterData: false};

      window.px.auth.loginUrl = this.loginUrl;
      window.px.auth.logoutUrl = this.logoutUrl;
      window.px.auth.userInfoUrl = this.userInfoUrl;
      window.px.auth.getUserInfo().then(function (data) {
        self.userInfo = data;
      });

      this.observer = new MutationObserver(
        function(){
          self.debounce(
            'width-change-handler',
            function(e){
              if (target.clientWidth >= 219) {
                self._onContainerExpanded();
                return;
              }
              if (target.clientWidth <= 55){
                self._onContainerCollapsed();
              }
            },
            300
          )
        }
      );
      this.observer.observe(target, config);
      window.onscroll = scroll;

      function scroll() {
        if (window.pageYOffset + window.innerHeight >= document.body.scrollHeight - 60) {
          self.toggleClass('sticky', true);
        } else {
          self.toggleClass('sticky', false);
        }
      }
  }

  , detached: function(){
    this.observer.disconnect();
  }

  , _onContainerExpanded: function(){
    this.toggleClass('login--collapsed', false, this.$.logincontainer);
  }

  , _onContainerCollapsed: function(){
    this.toggleClass('login--collapsed', true, this.$.logincontainer);
  }

  , loginHandler: function (event, detail, sender) {
    this.login();
  }

  , logoutHandler: function (event, detail, sender) {
    event.stopPropagation();
    this.logout();
  }

  , handleAjaxResponse: function(request) {
    this.set('userInfo', request.detail.response);
    this.set('isAuthenticated', true);
  }

  , handleAjaxError: function(error,a,b,c) {
    this.login();
  }

  , login: function (clientPath) {
      if (!this.loginUrl) {
          throw 'login url is not set';
      }
      if (!clientPath) {
        window.location.replace(this.loginUrl + '?state=' + location.href);
      } else {
        //this causes an error, what should it do?
        window.location.replace(this.loginUrl + '?state='+ clientPath.url);
      }
  }

  , logout: function () {
    if (!this.logoutUrl) {
      throw 'login url is not set';
    }
    window.location.replace(this.logoutUrl);
  }

});
</script>
